---
title: "assignment4"
author: "na"
date: "November 14, 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include = F}
library(tidyverse)
library(car)
library(userfriendlyscience)
library(knitr)
library(kableExtra)
library(effsize)

lsa <- read_csv("lobster_size_abundance.csv")
lt <- read_csv("lobster_traps.csv")
```

```{r include = F}
#___________________________________part 0___________________________________#

# remove nas and expand rows with count larger than 1
lsa_filt <- lsa %>%
  filter(SIZE != -99999) %>%
  uncount(weights = COUNT) %>%
  mutate(MPA = case_when(
    SITE == 'IVEE' ~ 'y',
    SITE == 'NAPL' ~ 'y',
    SITE == 'AQUE' ~ 'n',
    SITE == 'CARP' ~ 'n',
    SITE == 'MOHK' ~ 'n'))

```




```{r}
#___________________________________part 2___________________________________#

# filter for only 2017
lsa_filt2017 <- lsa_filt %>%
  filter(YEAR == 2017)

# look at site distributions
qq_site_means <- ggplot(lsa_filt2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE) +
  theme_classic()
qq_site_means

box_site_means <- ggplot(lsa_filt2017, aes(x = SITE, y = SIZE)) +
  geom_boxplot() +
  theme_classic()
box_site_means

# convert site to factor in lsa_filt
lsa_filt2017$SITE <- as.factor(lsa_filt2017$SITE)

# find site means, variance, etc.
lsa_site_means <- lsa_filt2017 %>%
  group_by(MPA, SITE) %>%
  summarize(
    mean_size = mean(SIZE),
    sd_size = sd(SIZE),
    var_size = var(SIZE),
    n = length(SIZE)
  ) %>%
  arrange(MPA) %>%
  mutate(yloc = mean_size + sd_size + 3.5) # loc of annotation

lsa_site_means$SITE <- factor(lsa_site_means$SITE, levels = c("IVEE","NAPL","AQUE","MOHK","CARP"))


# levines test for equal variances
lsa_levine <- leveneTest(SIZE ~ SITE, data = lsa_filt2017)
lsa_levine

# anova with unequal variances
lsa_aov_size_site <- oneway(lsa_filt2017$SITE, y = lsa_filt2017$SIZE, posthoc = 'games-howell', corrections = F, levene = T)
lsa_aov_size_site

# y loc for annotations
yloc_i <- lsa_site_means %>%
  filter(SITE == "IVEE") %>%
  pull(yloc)

yloc_n <- lsa_site_means %>%
  filter(SITE == "NAPL") %>%
  pull(yloc)

yloc_c <- lsa_site_means %>%
  filter(SITE == "CARP") %>%
  pull(yloc)

yloc_m <- lsa_site_means %>%
  filter(SITE == "MOHK") %>%
  pull(yloc)


#___________________plot___________________#
lsa_aov_colplt <- ggplot(lsa_site_means, aes(x = SITE, y = mean_size)) +
  geom_col(fill = "gray50", width = 0.5) +
  theme_classic() +
  geom_errorbar(aes(ymax =mean_size + sd_size, ymin = mean_size - sd_size), width = 0.1) +
  scale_y_continuous(expand = c(0,0), limits = c(0,100)) +
  labs(y=expression(Mean~lobster~carapace~length~(mm))) +
  scale_x_discrete(labels = c("Isla Vista","Naples Reef","Arroyo Quemado","Mohawk Reef", "Carpenteria")) +
  annotate("text", x = c(1), y = yloc_i, label = "a") +
  annotate("text", x = c(2), y = yloc_n, label = "a, b, c") +
  annotate("text", x = c(5), y = yloc_c, label = "b") +
  annotate("text", x = c(4), y = yloc_m, label = "c") +
  xlab("\nSite")
lsa_aov_colplt

ggsave(filename = "colplotlobstersize.png", plot = lsa_aov_colplt,
  scale = 1, width = 6, height = 4.5, units = "in",
  dpi = 300)

#___________________table___________________#
lsa_aov_tabledf <- lsa_site_means %>%
  ungroup() %>%
  mutate(sitel = case_when(
    SITE == "IVEE" ~ "Isla Vista",
    SITE == "NAPL" ~ "Naples Reef",
    SITE == "AQUE" ~ "Arroyo Quemado",
    SITE == "CARP" ~ "Carpinteria",
    SITE == "MOHK" ~ "Mohawk Reef")
    ) %>%
  select(sitel, mean_size, sd_size, n)

lsa_aov_table <- kable(lsa_aov_tabledf, 
                       format = "markdown",
                       caption = "Table 1. Mean and standard deviation of lobster carapace length at five California sites in 2017. Source: Santa   Barbara Coastal Long Term Ecological Research Project.", 
                       col.names=c('Site',
                                   'Mean carapace length (mm)',
                                   'Standard deviation of carapace length (mm)',
                                   'n'),
                       digits=2)
lsa_aov_table
```

















```{r include = F}
#___________________________________part 3___________________________________#
#Changes in lobster size at MPA and non-MPA sites (2012 v 2017)

#Dataframes for comparing 2012 to 2017 at MPA site and then nonMPA sites. 
lsa_MPA = lsa_filt %>% 
  filter(YEAR == 2012 | YEAR == 2017) %>% 
  filter(MPA == "y") %>% 
  group_by(YEAR)
lsa_nonMPA = lsa_filt %>% 
  filter(YEAR == 2012 | YEAR == 2017) %>% 
  filter(MPA == "n") %>% 
  group_by(YEAR)

#MPA samples look to be normally distributed
hist_MPA = ggplot(lsa_MPA, aes(SIZE)) +
  geom_histogram() +
  facet_wrap(~ YEAR)
qq_MPA = ggplot(lsa_MPA, aes(sample = SIZE)) +
  geom_qq() + 
  facet_wrap(~ YEAR) 

#nonMPA samples look to be normally distributed
hist_nonMPA = ggplot(lsa_nonMPA, aes(SIZE)) +
  geom_histogram() +
  facet_wrap(~ YEAR)
qq_nonMPA = ggplot(lsa_nonMPA, aes(sample = SIZE)) +
  geom_qq() + 
  facet_wrap(~ YEAR)


#Compare sample means of MPA 2012 vs 2017 sizes (two sample t.test)

#Vectors of 2012 and 2016 MPA
MPA12 = lsa_MPA %>% 
  filter(YEAR == "2012") %>% 
  pull(SIZE)
MPA17 = lsa_MPA %>% 
  filter(YEAR == "2017") %>% 
  pull(SIZE)

#Test for equal variance:
ftest_MPA = var.test(MPA12,MPA17) # p = .33, variances are equal

#Compare means with two sample t.test where varaiances are equal
ttest_MPA = t.test(MPA12,MPA17, var.equal = T)
ttest_MPA # p = .056 fail to reject null of no difference, not that unlikely to have pulled these sample means from populations with the same mean.




#Compare sample means of nonMPA 2012 vs 2017 sizes (two sample t.test)

#Vectors of 2012 and 2016 nonMPA
nonMPA12 = lsa_nonMPA %>% 
  filter(YEAR == "2012") %>% 
  pull(SIZE)
nonMPA17 = lsa_nonMPA %>% 
  filter(YEAR == "2017") %>% 
  pull(SIZE)

#Test for equal variance:
ftest_nonMPA = var.test(nonMPA12,nonMPA17) # p = .95, variances are equal

#Compare means with two sample t.test where varaiances are equal
ttest_nonMPA = t.test(nonMPA12,nonMPA17, var.equal = T)
ttest_nonMPA # p = .007, reject null of no difference, likely that these sample means are from populations with different means. 

#Effect size:
esize_nonMPA = cohen.d(nonMPA12, nonMPA17)
esize_nonMPA
```


Significance result for MPA t.test between 2012 and 2017:
(t(`r {ttest_MPA$parameter}`) = `r {round(ttest_MPA$statistic,3)}`, p = `r {round(ttest_MPA$p.value, 3)}`, $\alpha$ = 0.05)

Significance result for nonMPA t.test between 2012 and 2017:
(t(`r {ttest_nonMPA$parameter}`) = `r {round(ttest_nonMPA$statistic,3)}`, p = `r {round(ttest_nonMPA$p.value, 3)}`, $\alpha$ = 0.05)
effect size small:
(Cohen's $d$ = `r round(esize_nonMPA$estimate, 2) `) 


```{r}
#___________________________________part 4___________________________________#
#Proportions of “legal” lobsters at the 5 sites in 2017
#The legal minimum carapace size for lobster is 82.6 mm

lsa_legal <- lsa_filt2017 %>% 
  mutate(legal = case_when(
    SIZE > 82.6 ~ "y",
         SIZE < 82.6 ~ "n"))


sum_legal <- lsa_legal %>% 
  group_by(SITE) %>% 
  filter (legal == "y") %>% 
  summarize( 
    legal = length(legal))

sum_illegal <- lsa_legal %>% 
  group_by(SITE) %>% 
  filter (legal == "n") %>% 
  summarize( 
    illegal = length(legal))

legal_joined <- left_join(sum_legal, sum_illegal, by = "SITE") %>% 
  select(legal, illegal)

rownames(legal_joined) <- c('Arroyo Quemado', 'Carpenteria', 'Isla Vista', 'Mohawk Reef', 'Naples Reef')

#legal_table <- legal_joined create matrix

prop <- prop.table(as.matrix(legal_joined), 1)

prop_rounded <- round (prop, 2) #Round proportions to 2 digits
prop_rounded

prop_table <- kable(prop_rounded, 
                    format = "markdown", 
                    caption = "Table 2. Proportion of lobsters that are above the legal minimum carapace size for lobster (82.6 mm) at five California sites in 2017. Source: Santa Barbara Coastal Long Term Ecological Research Project.", 
      col.names = c('Proportion Above Minimum Size', 'Proportion Below Min Size'))

prop_table


legal_chi <- chisq.test(legal_joined)
legal_chi
 
```
A greater proportion of lobsters are below the legal minimum carapace size than above for all locations. The proportion of legal sized lobsters is smallest at Mohawk Reef as there is rougly 7 times more lobsters as this site that do not meet the legal minimum size. Naples Reef has the largest proportion of legal sized lobsters, roughly half that of the proportion of lobsters below the minimum size. 


**Research Question**: Is perception of UCSB's responsiveness to family needs dependent on gender?

**Research Question**: Is there an association between site and proportion of "legal" lobsters? 

#### Hypothesis Testing & Chi Square

Null Hypothesis: Location is independent of proportions of lobsters that are above the legal minimum. 
Alternative Hypothesis: Proportions of lobsters that are above the minimum size requirement are significantly different between sites.

**Conclusion**: Proportions of lobsters that are above the minimum size requirement differs significantly by site ($\chi$^2^(`r {legal_chi$parameter}`) = `r {round(legal_chi$statistic, 3)}`, *p* < 0.001,  $\alpha$ = 0.05).  

```{r}

legal_chi$observed
round(legal_chi$expected,0)

legal_chi$stdres #if standardized residuals are >2 this might be driving the significant finding
```
Naples and Mohawk Reefs might be driving significance. 

```{r}

legal_expand <- data.frame(expand.grid(rownames(prop), colnames(prop)), value = c(prop)) # moves from a contigency table format to an expanded table format where we can expand either row or column and then by what value

colnames(legal_expand) <- c("Site","Legality","Proportion")
View(legal_expand)

stacked_legal <- ggplot(legal_expand, aes(x = Site, y = Proportion)) +
  geom_col(aes(fill = Legality), width = 0.5) +
  theme_classic() +
  coord_flip()

stacked_legal
```


